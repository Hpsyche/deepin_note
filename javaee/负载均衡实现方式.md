

## 负载均衡实现方式

### HTTP重定向负载均衡

利用HTTP重定向协议实现负载均衡。

![](/media/hpsyche/_dde_data/note/javaee/pict/1-1.png)

HTTP重定向服务器是一台普通的应用服务器，其唯一个功能就是根据用户的HTTP请求计算出一台真实的服务器地址，并将该服务器地址写入HTTP重定向响应中（重定向响应状态码为302）返回给用户浏览器。用户浏览器在获取到响应之后，根据返回的信息，重新发送一个请求到真实的服务器上。如上图所示，浏览器访问www.apusapp.com，DNS服务器解析到IP地址为114.100.20.200，即HTTP重定向服务器的IP地址。重定向服务器计根据某种负载均衡算法算出真实的服务器地址为114.100.20.203并返回给用户浏览器，用户浏览器得到返回后重新对114.100.20.203发起了请求，最后完成访问。

#### 优缺点

优点：比较简单。

缺点：
浏览器需要两次请求服务器才能完成一次访问，性能较差；
同时，重定向服务器本身的处理能力有可能成为瓶颈，整个集群的伸缩性规模有限；
使用HTTP返回码302重定向，有可能使搜索引擎判断为SEO作弊，降低搜索排名。
因此实践中很少使用这种负载均衡方案来部署。

### DNS域名解析负载均衡

![](/media/hpsyche/_dde_data/note/javaee/pict/1-2.png)

 由上图可以看出，在DNS服务器中应该配置了多个A记录，如：

   www.apusapp.com IN A 114.100.20.201;

   www.apusapp.com IN A 114.100.20.202;

   www.apusapp.com IN A 114.100.20.203;

因此，每次域名解析请求都会根据对应的负载均衡算法计算出一个不同的IP地址并返回，这样A记录中配置多个服务器就可以构成一个集群，并可以实现负载均衡。上图中，用户请求www.apusapp.com，DNS根据A记录和负载均衡算法计算得到一个IP地址114.100.20.203，并返回给浏览器，浏览器根据该IP地址，访问真实的物理服务器114.100.20.203。所有这些操作对用户来说都是透明的，用户可能只知道www.apusapp.com这个域名。

#### 优缺点

  **DNS域名解析负载均衡有如下优点：**

> 1. 将负载均衡的工作交给DNS，省去了网站管理维护负载均衡服务器的麻烦。
>
> 2. 技术实现比较灵活、方便，简单易行，成本低，使用于大多数TCP/IP应用。
> 3.  对于部署在服务器上的应用来说不需要进行任何的代码修改即可实现不同机器上的应用访问。
> 4. 服务器可以位于互联网的任意位置。
> 5. 同时许多DNS还支持基于地理位置的域名解析，即会将域名解析成距离用户地理最近的一个服务器地址，这样就可以加速用户访问，改善性能。

  **同时，DNS域名解析也存在如下缺点：**

> 1. 目前的DNS是多级解析的，每一级DNS都可能缓存A记录，当某台服务器下线之后，即使修改了A记录，要使其生效也需要较长的时间，这段时间，DNS任然会将域名解析到已下线的服务器上，最终导致用户访问失败。
>
> 2. 不能够按服务器的处理能力来分配负载。DNS负载均衡采用的是简单的轮询算法，不能区分服务器之间的差异，不能反映服务器当前运行状态，所以其的负载均衡效果并不是太好。
>
> 3. 可能会造成额外的网络问题。为了使本DNS服务器和其他DNS服务器及时交互，保证DNS数据及时更新，使地址能随机分配，一般都要将DNS的刷新时间设置的较小，但太小将会使DNS流量大增造成额外的网络问题。

事实上，大型网站总是部分使用DNS域名解析，利用域名解析作为第一级负载均衡手段，即域名解析得到的一组服务器并不是实际提供服务的物理服务器，而是同样提供负载均衡服务器的内部服务器，这组内部负载均衡服务器再进行负载均衡，请请求发到真实的服务器上，最终完成请求。

### 反向代理负载均衡

反向代理（Reverse Proxy）方式是指以代理服务器来接受internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给internet上请求连接的客户端，此时代理服务器对外就表现为一个服务器，该服务器就可称之为代理服务器。由于代理服务器处在最终处理请求访问的服务器之前，因此可以在代理服务器上做负载均衡。实际上，互联网中也大量的存在反向代理服务器提供代理功能的同时也提供负载均衡的功能。其工作原理如下图所示：

![](/media/hpsyche/_dde_data/note/javaee/pict/1-3.png)

反向代理服务器，管理了一组服务器，可以根据对应的负载均衡算法将不同的请求转发到不同的服务器上。服务器处理完成的响应也通过代理服务器返回给用户。**由于内部服务器不直接对外提供访问，因此，内部服务器地址不需要使用外部IP，而反向代理服务器则需要配置双网卡，提供内部和对外访问的IP地址。**

如上图，用户浏览器访问请求的地址是114.100.20.200，反向代理服务器接收到请求后，根据负载均衡算法计算得到一台真实的内部服务器地址192.168.1.1，并将用户的请求转发到该服务器上，192.168.1.1处理完请求后将响应返回给反相代理服务器，反相代理服务器再将该响应的内容返回给用户。

与此同时，反相代理服务器还可以具有存储静态数据用于缓存的功能，从而加速处理用户请求，提高服务器处理性能，其工作原理大概如下图所示：

![](/media/hpsyche/_dde_data/note/javaee/pict/1-4.png)

反向代理服务器转发请求处于应用层协议上，因此，也称之为应用层负载均衡。

常用的反向代理服务器如nginx其最大并发数为5w。

#### 优缺点

该负载均衡方案与反向代理服务器功能集成到了一起，**部署相对简单。**

但是，反向代理服务器会处理所有的请求和响应，**其性能可能将会成为整个集群的瓶颈。**

### IP负载均衡

首先看IP协议的报头格式：

![](/media/hpsyche/_dde_data/note/javaee/pict/1-5.png)

内红色框内的源地址和目的地址是IP负载均衡功能的关键所在，IP负载均衡又可以称之为网络层负载均衡，其核心原理就是通过内核驱动更改IP的目的地址来完成数据负载均衡的，如下图：

![](/media/hpsyche/_dde_data/note/javaee/pict/1-6.png)

如上图所示，用户请求数据包（源地址为200.110.50.1）到达负载均衡服务器114.100.20.200后，负载均衡服务器在内核进程获取网络数据包，根据一定的负载均衡算法得到一台内部的真实服务器192.168.1.1，然后**在内核进程中将数据包的目的IP修改为192.168.1.1**（不需要通过用户进程处理），此后数据包将会被发往192.168.1.1的服务器上，服务器处理完后，将向负载均衡服务器返回相应的数据包，负载均衡服务器在把源地址修改为114.100.20.200后将数据包传输给用户浏览器。在这一整个过程中，数据包没有通过用户的应用进程，因此该负载均衡的性能是非常之高的。

#### 优缺点

IP负载均衡在内核进程完成数据分发，较反向代理负载均衡（在应用程序中分发数据）有更好的处理性能。

但是由于所有请求和响应都要经过负载均衡服务器，集群的最大响应数据吞吐量将受到负载均衡服务器网卡带宽的限制，对于提供下载服务或者视频服务等需要大量传输数据的站点而言，这是难以满足需求的。

要是能**让响应数据包绕过负载均衡服务器直接发往用户机器上**就好了，有什么办法可以做到呢？当然有，那就是链路层的负载均衡，这将在下一博文中讲解。

### 数据链路层负载均衡

在TCP/IP协议中数据链路层处于最底层，以帧的形式传输和接受数据。

数据链路层负载均衡通过修改通信协议数据包的mac地址进行负载均衡，集群可以通过如下图的部署来达到负载均衡：

![](/media/hpsyche/_dde_data/note/javaee/pict/1-7.png)

这种数据传输方式又称为三角传输，负载均衡**数据分发过程中不修改IP地址，只修改目的MAC地址**，通过配置真实物理服务器集群**所有机器虚拟IP和负载均衡服务器IP一致**，从而达到不修改数据包的源地址和目的地址就可以进行数据分发的目的，由于实际处理请求的真实物理服务器IP和数据请求目的IP一致，**不需要通过负载均衡服务器进行地址交换，可将响应数据包直接返回给用户浏览器，避免负载均衡服务器网卡带宽成为瓶颈**。这种负载均衡方式又称之为直接路由方式（DR）.

如上图所示，用户请求到达负载均衡服务器114.100.20.200后，负载均衡服务器将数据包的目的MAC地址更改为00:1e:ec:bc:5e:03，并不修改数据包目的IP，由于服务器集群所有服务器的虚拟IP地址和负载均衡服务器IP地址一致，因此数据可以正常传输到达MAC地址为00:1e:ec:bc:5e:03的机器上，该服务器处理完之后，将响应数据包发送到网关服务器，网关服务器直接将数据包发送给用户浏览器，响应数据不需要通过负载均衡服务器，这样就避免了负载均衡服务器成为传输瓶颈的可能。

使用三角传输模式的链路层负载均衡是目前大型网站使用最为广泛的一种负载均衡手段。在Linux平台上最好的链路层负载均衡开源产品是LVS(Linux Virtual Server)。

## 负载均衡算法

* 轮询
* 加权轮询
* 随机
* 最少连接
* 源地址三列（实现会话黏滞）